name: Deploy Docker Image
on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up SSH keys ðŸ”‘
        uses: webfactory/ssh-agent@v0.7.0
        with: 
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
            
      - name: Download key pair file
        run: |
          echo "${{ secrets.EC2_KEY_PAIR }}" > ~/.ssh/key_pair.pem
          chmod 600 ~/.ssh/key_pair.pem
          
      - name: Upload private key as artifact
        uses: actions/upload-artifact@v3
        with:
          name: private-key
          path: ~/.ssh/key_pair.pem

      - name: Download private key artifact
        uses: actions/download-artifact@v3
        with:
          name: private-key

      - name: Connect to EC2 instance
        run: |
          mkdir -p ~/.ssh
          mv private-key/key_pair.pem ~/.ssh/
          chmod 600 ~/.ssh/key_pair.pem

          ssh -i ~/.ssh/key_pair.pem ec2-user@${{ secrets.INSTANCE_IP }} << 'EOF'
          sudo yum update -y
          EOF
      
      - name: Pull Docker image
        run: docker pull olixc/apache-webapp  

      - name: Run Docker Container
        run: docker run -d -p 80:80 olixc/apache-webapp
