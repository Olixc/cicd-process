name: Deploy Docker Image
on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up SSH keys ðŸ”‘
        uses: webfactory/ssh-agent@v0.7.0
        with: 
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Set private key permissions
        run: chmod 600 ${{ env.KEY_PATH }}

      - name: Connect to EC2 instance
        run: |
          ssh -i ${{ env.KEY_PATH }} ec2-user@${{ secrets.INSTANCE_IP }} << 'EOF'
          sudo yum update -y
      
      - name: Pull Docker image
        run: docker pull olixc/apache-webapp  

      - name: Run Docker Container
        run: docker run -d -p 80:80 olixc/apache-webapp
